<!DOCTYPE html>
<html lang="tr">
  <head>
    <meta charset="UTF-8" />
    <title>Yorumlar</title>
    <style>
      #comments p {
        border-bottom: 1px solid #ccc;
        padding: 5px 0;
        margin: 0;
      }
      textarea,
      input {
        width: 100%;
        margin-top: 10px;
        padding: 6px;
        box-sizing: border-box;
      }
      button {
        margin-top: 5px;
        padding: 6px 12px;
      }
      .comment-date {
        font-size: 0.8em;
        color: gray;
      }
    </style>
  </head>
  <body>
    <h2>Yorumlar</h2>
    <div id="comments">Yükleniyor...</div>

    <input type="text" id="nickname" placeholder="Takma adınızı girin..." />
    <textarea id="commentText" placeholder="Yorumunuzu yazın..."></textarea><br />
    <button id="sendBtn">Gönder</button>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        query,
        where,
        orderBy,
        onSnapshot,
        Timestamp,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

      // Firebase config - kendi projene göre güncelle
      const firebaseConfig = {
        apiKey: "AIzaSyDx101DUQr-LvhW8K7woVJ58_a74TkkgJM",
        authDomain: "ucbgcomment.firebaseapp.com",
        projectId: "ucbgcomment",
        storageBucket: "ucbgcomment.firebasestorage.app",
        messagingSenderId: "1006694508007",
        appId: "1:1006694508007:web:9f3a4413dbdeacfeee0942",
      };

      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);

      const pageId = window.location.pathname.replace(/\/$/, "");
      const commentsDiv = document.getElementById("comments");

      function formatDate(ts) {
        if (!ts) return "";
        if (ts.toDate) return ts.toDate().toLocaleString("tr-TR");
        if (ts.seconds) return new Date(ts.seconds * 1000).toLocaleString("tr-TR");
        return new Date(ts).toLocaleString("tr-TR");
      }

      // Yorumları canlı dinle, en yeni en üstte olsun
      function loadComments() {
        const q = query(collection(db, "comments"), where("page", "==", pageId), orderBy("date", "desc"));

        onSnapshot(q, (snapshot) => {
          if (snapshot.empty) {
            commentsDiv.innerHTML = "<p>Henüz yorum yok.</p>";
            return;
          }

          let html = "";
          snapshot.forEach((doc) => {
            const c = doc.data();
            html += `
            <p>
              <strong>${c.nickname || "Anonim"}:</strong> ${c.text}<br>
              <span class="comment-date">${formatDate(c.date)}</span>
            </p>
          `;
          });

          commentsDiv.innerHTML = html;
        });
      }

      // Cloud Function endpoint (kendin oluşturduğun URL)
      const functionUrl = "https://us-central1-ucbgcomment.cloudfunctions.net/addComment";

      document.getElementById("sendBtn").addEventListener("click", async () => {
        const nickname = document.getElementById("nickname").value.trim();
        const text = document.getElementById("commentText").value.trim();

        if (!nickname || !text) {
          alert("Lütfen takma ad ve yorum girin.");
          return;
        }

        try {
          const res = await fetch(functionUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ page: pageId, nickname, text }),
          });

          const data = await res.json();

          if (data.success) {
            alert("Yorumunuz başarıyla gönderildi.");
            document.getElementById("commentText").value = "";
            document.getElementById("nickname").value = "";
          } else {
            alert("Yorum gönderilemedi: " + (data.error || "Bilinmeyen hata"));
          }
        } catch (err) {
          alert("Sunucu ile iletişimde hata: " + err.message);
        }
      });

      loadComments();
    </script>
  </body>
</html>
